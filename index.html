<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>QR Studio</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

<style>
  :root{
    --bg:#0b0f1a;
    --panel:#111827;
    --panel2:#0f172a;
    --stroke: rgba(255,255,255,.08);
    --stroke2: rgba(255,255,255,.12);
    --text:#e5e7eb;
    --muted: rgba(229,231,235,.72);
    --muted2: rgba(229,231,235,.55);
    --accent:#5563ff;
    --danger:#ef4444;
    --warn:#f59e0b;
    --good:#22c55e;
    --shadow: 0 18px 60px rgba(0,0,0,.45);
    --r: 18px;
    --r2: 24px;
  }
  body.light{
    --bg:#f6f7fb;
    --panel:#ffffff;
    --panel2:#f3f4f6;
    --stroke: rgba(15,23,42,.10);
    --stroke2: rgba(15,23,42,.16);
    --text:#0b1020;
    --muted: rgba(11,16,32,.72);
    --muted2: rgba(11,16,32,.55);
    --shadow: 0 14px 46px rgba(15,23,42,.14);
  }

  *{ box-sizing:border-box; }
  html,body{ height:100%; }
  body{
    margin:0;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "SF Pro Text", Arial, sans-serif;
    background: var(--bg);
    color: var(--text);
  }

  .shell{
    width: min(1180px, 100%);
    margin: 0 auto;
    padding: clamp(14px, 2vw, 24px);
  }

  .topbar{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    margin-bottom: clamp(12px, 2vw, 18px);
  }

  .brand{
    display:flex;
    align-items:center;
    gap:12px;
  }
  .mark{
    width:36px; height:36px;
    border-radius: 14px;
    background: var(--panel);
    border: 1px solid var(--stroke2);
    box-shadow: var(--shadow);
    position: relative;
  }
  .mark:after{
    content:"";
    position:absolute;
    inset: 10px;
    border-radius: 10px;
    border: 2px solid var(--accent);
    opacity: .9;
  }
  .brandText{
    display:flex;
    flex-direction:column;
    line-height:1.1;
  }
  .brandText b{
    letter-spacing:.08em;
    font-size: 13px;
    text-transform:uppercase;
  }
  .brandText span{
    font-size: 12px;
    color: var(--muted2);
  }

  .actions{
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    justify-content:flex-end;
  }

  .btn, .chip{
    appearance:none;
    border:1px solid var(--stroke2);
    background: var(--panel);
    color: var(--text);
    border-radius: 999px;
    padding: 10px 12px;
    font-size: 13px;
    display:inline-flex;
    align-items:center;
    gap:8px;
    cursor:pointer;
    transition: transform .12s ease, opacity .12s ease, border-color .12s ease;
  }
  .btn:hover, .chip:hover{
    transform: translateY(-1px);
    border-color: var(--stroke2);
    opacity: .98;
  }
  .btn.primary{
    background: var(--accent);
    border-color: transparent;
    color: #fff;
  }
  .btn.danger{
    background: transparent;
    border-color: rgba(239,68,68,.45);
    color: rgba(239,68,68,.95);
  }

  .grid{
    display:grid;
    grid-template-columns: 1fr 420px;
    gap: clamp(12px, 2vw, 18px);
    align-items:start;
  }
  @media (max-width: 980px){
    .grid{ grid-template-columns: 1fr; }
  }

  .panel{
    background: var(--panel);
    border: 1px solid var(--stroke);
    border-radius: var(--r2);
    box-shadow: var(--shadow);
    overflow:hidden;
  }

  .panelHeader{
    padding: 18px 18px 14px;
    border-bottom: 1px solid var(--stroke);
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:12px;
  }
  .panelHeader h1{
    margin:0;
    font-size: 20px;
    letter-spacing:.01em;
  }
  .panelHeader p{
    margin:6px 0 0;
    font-size:13px;
    color: var(--muted);
    max-width: 64ch;
  }

  .panelBody{ padding: 16px 18px 18px; }

  .sectionTitle{
    font-size: 12px;
    letter-spacing: .14em;
    text-transform: uppercase;
    color: var(--muted2);
    margin: 14px 0 10px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
  }

  .formGrid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }
  @media (max-width: 560px){
    .formGrid{ grid-template-columns: 1fr; }
  }

  label{
    font-size: 12px;
    color: var(--muted2);
    display:block;
    margin: 0 0 6px;
  }

  .field{
    width:100%;
    padding: 11px 12px;
    border-radius: 14px;
    border: 1px solid var(--stroke2);
    background: var(--panel2);
    color: var(--text);
    font-size: 14px;
    outline: none;
    transition: border-color .12s ease, box-shadow .12s ease;
  }
  .field:focus{
    border-color: rgba(85,99,255,.75);
    box-shadow: 0 0 0 3px rgba(85,99,255,.18);
  }

  /* IMPORTANT: prevent white-on-white dropdown issues */
  select.field{
    appearance:none;
    background-image:
      linear-gradient(45deg, transparent 50%, var(--muted) 50%),
      linear-gradient(135deg, var(--muted) 50%, transparent 50%);
    background-position:
      calc(100% - 18px) 55%,
      calc(100% - 12px) 55%;
    background-size: 6px 6px, 6px 6px;
    background-repeat: no-repeat;
    padding-right: 36px;
  }
  select.field option{
    background: var(--panel2);
    color: var(--text);
  }

  .hint{
    font-size: 12px;
    color: var(--muted2);
    margin-top: 6px;
    line-height: 1.4;
  }

  .divider{
    height:1px;
    background: var(--stroke);
    margin: 14px 0;
  }

  /* Preview */
  .previewPad{ padding: 18px; }
  .previewCard{
    border: 1px solid var(--stroke);
    border-radius: var(--r2);
    padding: 16px;
    background: var(--panel);
  }

  .previewHead{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:12px;
    margin-bottom: 12px;
  }
  .meta b{ font-size: 14px; }
  .meta span{ display:block; font-size: 12px; color: var(--muted2); margin-top:4px; }

  .pill{
    font-size:12px;
    padding:6px 10px;
    border-radius:999px;
    border: 1px solid var(--stroke2);
    background: var(--panel2);
    color: var(--muted);
    white-space:nowrap;
  }
  .pill.ok{ border-color: rgba(34,197,94,.35); color: rgba(34,197,94,.95); }
  .pill.warn{ border-color: rgba(245,158,11,.45); color: rgba(245,158,11,.95); }

  .canvasBox{
    width:100%;
    display:grid;
    place-items:center;
    padding: 14px;
    border-radius: 20px;
    border: 1px solid var(--stroke);
    background: var(--panel2);
  }
  canvas{
    background: #fff;
    border-radius: 16px;
    max-width: 100%;
    height: auto;
    display:block;
  }

  .toolGrid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-top: 12px;
  }
  @media (max-width: 420px){
    .toolGrid{ grid-template-columns: 1fr; }
  }

  .toast{
    position: fixed;
    left: 50%;
    bottom: 18px;
    transform: translateX(-50%);
    background: var(--panel);
    border: 1px solid var(--stroke2);
    box-shadow: var(--shadow);
    border-radius: 999px;
    padding: 10px 12px;
    color: var(--text);
    font-size: 13px;
    display:none;
    align-items:center;
    gap:10px;
    z-index: 50;
    max-width: min(720px, calc(100% - 24px));
  }
  .toast .dot{
    width:10px;height:10px;border-radius:999px;background: var(--warn);
  }
  .toast.show{ display:flex; }
  .toast .msg{ color: var(--muted); }
  .toast .msg b{ color: var(--text); font-weight:600; }

  /* History */
  .historyRow{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
  }
  @media (max-width: 560px){
    .historyRow{ flex-wrap:nowrap; overflow-x:auto; padding-bottom:6px; }
  }
  .thumb{
    width:66px; height:66px;
    border-radius: 16px;
    border: 1px solid var(--stroke2);
    background: #fff;
    object-fit: contain;
    cursor:pointer;
    transition: transform .12s ease;
  }
  .thumb:hover{ transform: translateY(-2px); }

  /* Print: only show the preview panel */
  @media print{
    body{ background:#fff !important; }
    .topbar, .grid > section, .toolGrid, .hint, .divider, .sectionTitle, .historyRow, .actions { display:none !important; }
    .shell{ padding:0 !important; width:100% !important; }
    .panel{ border:none !important; box-shadow:none !important; }
    .previewPad{ padding:0 !important; }
    .previewCard{ border:none !important; padding:0 !important; }
    .canvasBox{ border:none !important; background:transparent !important; padding:0 !important; }
    canvas{ border-radius:0 !important; }
  }
</style>
</head>

<body>
  <div class="shell">
    <div class="topbar">
      <div class="brand">
        <div class="mark" aria-hidden="true"></div>
        <div class="brandText">
          <b>QR Studio</b>
          <span>Clean QR generation with safe logo support</span>
        </div>
      </div>
      <div class="actions">
        <button class="chip" type="button" onclick="toggleTheme()"><span id="themeIcon">üåô</span> <span id="themeLabel">Dark</span></button>
        <button class="chip" type="button" onclick="clearHistory()">Clear history</button>
      </div>
    </div>

    <div class="grid">
      <!-- Builder -->
      <section class="panel">
        <div class="panelHeader">
          <div>
            <h1>Builder</h1>
            <p>No gradients, strong contrast, and a logo system that won‚Äôt silently produce unscannable QR codes.</p>
          </div>
          <div class="pill" id="builderPill">Ready</div>
        </div>

        <div class="panelBody">
          <div class="sectionTitle">Content</div>

          <div class="formGrid">
            <div>
              <label for="mode">Mode</label>
              <select id="mode" class="field">
                <option value="url">URL</option>
                <option value="text">Plain Text</option>
                <option value="email">Email</option>
                <option value="sms">SMS</option>
                <option value="tel">Phone Number</option>
                <option value="wifi">Wi-Fi Login</option>
                <option value="vcard">vCard Contact</option>
              </select>
              <div class="hint">Include https:// for links.</div>
            </div>

            <div>
              <label for="sizeSelect">QR Size</label>
              <select id="sizeSelect" class="field">
                <option value="auto" selected>Auto (fits device)</option>
                <option value="240">Small</option>
                <option value="300">Medium</option>
                <option value="360">Large</option>
                <option value="440">XL</option>
              </select>
              <div class="hint">Auto scales to the preview area.</div>
            </div>
          </div>

          <div id="inputs" style="margin-top:12px;"></div>

          <div class="divider"></div>

          <div class="sectionTitle">Logo</div>

          <div class="formGrid">
            <div>
              <label for="logoInput">Logo image (optional)</label>
              <input id="logoInput" class="field" type="file" accept="image/*" />
              <div class="hint">PNG recommended. When enabled, error correction switches to <b>H</b>.</div>
            </div>
            <div>
              <label for="logoScale">Logo size</label>
              <select id="logoScale" class="field">
                <option value="0" selected>None</option>
                <option value="0.14">Small</option>
                <option value="0.18">Medium</option>
                <option value="0.22">Large (max safe)</option>
              </select>
              <div class="hint">Logo is clamped automatically if too large.</div>
            </div>
          </div>

          <div class="formGrid" style="margin-top:10px;">
            <div>
              <label for="logoPadding">Logo backing</label>
              <select id="logoPadding" class="field">
                <option value="0.10" selected>Normal</option>
                <option value="0.14">More</option>
                <option value="0.06">Less</option>
              </select>
              <div class="hint">Adds a white buffer for better scanning.</div>
            </div>
            <div>
              <label for="logoCorner">Corner radius</label>
              <select id="logoCorner" class="field">
                <option value="0.18" selected>Rounded</option>
                <option value="0.0">Square</option>
                <option value="0.28">Extra rounded</option>
              </select>
              <div class="hint">Purely visual.</div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="sectionTitle">Actions</div>

          <div class="formGrid">
            <button class="btn primary" type="button" onclick="generate()">Generate</button>
            <button class="btn" type="button" onclick="printQR()">Print</button>
          </div>

          <div class="formGrid" style="margin-top:10px;">
            <button class="btn" type="button" onclick="download('png')">Export PNG</button>
            <button class="btn" type="button" onclick="download('jpeg')">Export JPEG</button>
          </div>

          <div class="divider"></div>

          <div class="sectionTitle">Recent (last 5)</div>
          <div id="history" class="historyRow"></div>
        </div>
      </section>

      <!-- Preview -->
      <aside class="panel">
        <div class="previewPad">
          <div class="previewCard">
            <div class="previewHead">
              <div class="meta">
                <b>Preview</b>
                <span id="metaText">No QR generated yet</span>
              </div>
              <div class="pill warn" id="scanPill">Not generated</div>
            </div>

            <div class="canvasBox" id="canvasBox">
              <canvas id="qrcanvas"></canvas>
            </div>

            <div class="toolGrid">
              <button class="btn" type="button" onclick="copyText()">Copy encoded text</button>
              <button class="btn" type="button" onclick="copyImage()">Copy QR image</button>
            </div>

            <div class="hint" style="margin-top:10px;">
              If you insist on a big logo, scanning can fail. We clamp it to keep your QR usable.
            </div>
          </div>
        </div>
      </aside>
    </div>
  </div>

  <div class="toast" id="toast">
    <div class="dot"></div>
    <div class="msg" id="toastMsg"></div>
  </div>

<script>
  // ---------- UI templates ----------
  const templates = {
    url: `
      <div class="formGrid">
        <div style="grid-column:1/-1;">
          <label>URL</label>
          <input id="data1" class="field" placeholder="https://example.com" />
        </div>
      </div>
    `,
    text: `
      <div class="formGrid">
        <div style="grid-column:1/-1;">
          <label>Text</label>
          <input id="data1" class="field" placeholder="Any text..." />
        </div>
      </div>
    `,
    email: `
      <div class="formGrid">
        <div>
          <label>Email</label>
          <input id="data1" class="field" placeholder="address@example.com" />
        </div>
        <div>
          <label>Subject</label>
          <input id="data2" class="field" placeholder="Subject" />
        </div>
        <div style="grid-column:1/-1;">
          <label>Message</label>
          <input id="data3" class="field" placeholder="Body text" />
        </div>
      </div>
    `,
    sms: `
      <div class="formGrid">
        <div>
          <label>Phone</label>
          <input id="data1" class="field" placeholder="+1 555 123 4567" />
        </div>
        <div style="grid-column:1/-1;">
          <label>Message</label>
          <input id="data2" class="field" placeholder="Hi!" />
        </div>
      </div>
    `,
    tel: `
      <div class="formGrid">
        <div style="grid-column:1/-1;">
          <label>Phone</label>
          <input id="data1" class="field" placeholder="+1 555 123 4567" />
        </div>
      </div>
    `,
    wifi: `
      <div class="formGrid">
        <div>
          <label>Network SSID</label>
          <input id="data1" class="field" placeholder="MyWiFi" />
        </div>
        <div>
          <label>Password</label>
          <input id="data2" class="field" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
        </div>
        <div style="grid-column:1/-1;">
          <label>Security</label>
          <select id="data3" class="field">
            <option value="WPA" selected>WPA/WPA2</option>
            <option value="WEP">WEP</option>
            <option value="nopass">No Password</option>
          </select>
        </div>
      </div>
    `,
    vcard: `
      <div class="formGrid">
        <div>
          <label>Full Name</label>
          <input id="data1" class="field" placeholder="Ada Lovelace" />
        </div>
        <div>
          <label>Company</label>
          <input id="data4" class="field" placeholder="QR Studio" />
        </div>
        <div>
          <label>Phone</label>
          <input id="data2" class="field" placeholder="+1 555 123 4567" />
        </div>
        <div>
          <label>Email</label>
          <input id="data3" class="field" placeholder="ada@example.com" />
        </div>
      </div>
    `
  };

  const $ = (id) => document.getElementById(id);

  const modeEl = $("mode");
  const inputsEl = $("inputs");
  const sizeSelect = $("sizeSelect");
  const builderPill = $("builderPill");
  const scanPill = $("scanPill");
  const metaText = $("metaText");
  const canvasBox = $("canvasBox");
  const canvas = $("qrcanvas");

  const logoInput = $("logoInput");
  const logoScaleEl = $("logoScale");
  const logoPaddingEl = $("logoPadding");
  const logoCornerEl = $("logoCorner");

  const toast = $("toast");
  const toastMsg = $("toastMsg");

  function showToast(html){
    toastMsg.innerHTML = html;
    toast.classList.add("show");
    clearTimeout(window.__toastTimer);
    window.__toastTimer = setTimeout(() => toast.classList.remove("show"), 2600);
  }

  function setPills(builderText, scanState){
    builderPill.textContent = builderText;
    scanPill.className = "pill " + (scanState === "ok" ? "ok" : "warn");
    scanPill.textContent = scanState === "ok" ? "Ready to scan" : "Not generated";
  }

  function buildInputs(){
    inputsEl.innerHTML = templates[modeEl.value] || "";
    setPills("Ready", "warn");
    metaText.textContent = "No QR generated yet";
  }
  modeEl.addEventListener("change", buildInputs);
  buildInputs();

  // ---------- Responsive QR sizing ----------
  function autoSize(){
    const rect = canvasBox.getBoundingClientRect();
    const pad = 28;
    // Fit to box; keep it crisp but not massive
    return Math.max(220, Math.min(520, Math.floor(Math.min(rect.width, rect.height) - pad)));
  }
  function chosenSize(){
    const v = sizeSelect.value;
    return v === "auto" ? autoSize() : parseInt(v, 10);
  }

  // ---------- QR + logo ----------
  let qrGenerated = false;
  let lastText = "";
  let logoImg = null;

  function initQR(value=""){
    const size = chosenSize();
    canvas.width = size;
    canvas.height = size;
    // Level: H if logo enabled, else M (good default)
    const logoOn = (parseFloat(logoScaleEl.value) > 0) && !!logoImg;
    const level = logoOn ? "H" : "M";

    // Create new instance each time to avoid resize weirdness
    window.qr = new QRious({
      element: canvas,
      size,
      value,
      level,
      foreground: "#0b1020",
      background: "#ffffff"
    });
  }

  function roundRectPath(ctx, x, y, w, h, r){
    const rr = Math.max(0, Math.min(r, Math.min(w,h)/2));
    ctx.beginPath();
    ctx.moveTo(x+rr, y);
    ctx.arcTo(x+w, y, x+w, y+h, rr);
    ctx.arcTo(x+w, y+h, x, y+h, rr);
    ctx.arcTo(x, y+h, x, y, rr);
    ctx.arcTo(x, y, x+w, y, rr);
    ctx.closePath();
  }

  // Safe logo clamp to avoid killing scannability
  function maxSafeLogoScale(){
    // Conservative cap: 0.22 works in many cases at level H.
    // If content is long, QR gets denser; logo must be smaller.
    const len = (lastText || "").length;
    if (len > 180) return 0.14;
    if (len > 120) return 0.16;
    if (len > 80)  return 0.18;
    return 0.22;
  }

  function overlayLogo(){
    const scaleWanted = parseFloat(logoScaleEl.value);
    if (!logoImg || !scaleWanted) return;

    const cap = maxSafeLogoScale();
    const scale = Math.min(scaleWanted, cap);

    if (scaleWanted > cap){
      // auto-correct UI to match clamp so user sees reality
      // find closest option <= cap
      const opts = Array.from(logoScaleEl.options).map(o => parseFloat(o.value));
      const best = Math.max(...opts.filter(v => v <= cap));
      logoScaleEl.value = String(best);
      showToast(`Logo was too large for this QR density. Clamped to <b>${Math.round(best*100)}%</b> for scannability.`);
    }

    const ctx = canvas.getContext("2d");
    const size = canvas.width;
    const logoSize = Math.floor(size * scale);
    const x = Math.floor((size - logoSize) / 2);
    const y = Math.floor((size - logoSize) / 2);

    const padFactor = parseFloat(logoPaddingEl.value);
    const pad = Math.floor(logoSize * padFactor);
    const cornerFactor = parseFloat(logoCornerEl.value);
    const radius = Math.floor(logoSize * cornerFactor);

    // White backing (quiet zone under logo)
    ctx.save();
    ctx.fillStyle = "#ffffff";
    roundRectPath(ctx, x - pad, y - pad, logoSize + pad*2, logoSize + pad*2, radius + Math.floor(pad*0.75));
    ctx.fill();
    ctx.restore();

    // Clip + draw logo
    ctx.save();
    roundRectPath(ctx, x, y, logoSize, logoSize, radius);
    ctx.clip();
    ctx.drawImage(logoImg, x, y, logoSize, logoSize);
    ctx.restore();
  }

  function render(text){
    initQR(text);
    overlayLogo();
  }

  // Rerender on resize / size changes
  window.addEventListener("resize", () => {
    clearTimeout(window.__resize);
    window.__resize = setTimeout(() => {
      if (qrGenerated) render(lastText);
    }, 120);
  });
  sizeSelect.addEventListener("change", () => { if (qrGenerated) render(lastText); });
  logoScaleEl.addEventListener("change", () => { if (qrGenerated) render(lastText); });
  logoPaddingEl.addEventListener("change", () => { if (qrGenerated) render(lastText); });
  logoCornerEl.addEventListener("change", () => { if (qrGenerated) render(lastText); });

  logoInput.addEventListener("change", (e) => {
    const file = e.target.files?.[0];
    if (!file){
      logoImg = null;
      if (qrGenerated) render(lastText);
      return;
    }
    const img = new Image();
    img.onload = () => { logoImg = img; if (qrGenerated) render(lastText); };
    img.onerror = () => { logoImg = null; showToast("Could not load logo image."); };
    img.src = URL.createObjectURL(file);
  });

  // ---------- Build QR data ----------
  function g(id){ return document.getElementById(id)?.value || ""; }

  function buildData(){
    const mode = modeEl.value;
    let out = "";
    if (mode === "url") out = g("data1").trim();
    else if (mode === "text") out = g("data1");
    else if (mode === "email"){
      const e = g("data1").trim();
      const s = g("data2");
      const m = g("data3");
      out = `mailto:${e}?subject=${encodeURIComponent(s)}&body=${encodeURIComponent(m)}`;
    } else if (mode === "sms"){
      out = `SMSTO:${g("data1").trim()}:${g("data2")}`;
    } else if (mode === "tel"){
      out = `tel:${g("data1").trim()}`;
    } else if (mode === "wifi"){
      const ssid = g("data1");
      const pass = g("data2");
      const enc = (document.getElementById("data3") || {}).value || "WPA";
      out = `WIFI:T:${enc};S:${ssid};P:${pass};;`;
    } else if (mode === "vcard"){
      const n = g("data1");
      const p = g("data2");
      const e = g("data3");
      const c = g("data4");
      out =
`BEGIN:VCARD
VERSION:3.0
FN:${n}
ORG:${c}
TEL:${p}
EMAIL:${e}
END:VCARD`;
    }
    return (out || "").trim();
  }

  function setMeta(text){
    const short = (text || "").length > 46 ? text.slice(0,46) + "‚Ä¶" : text;
    metaText.textContent = short || "No QR generated yet";
  }

  // ---------- History ----------
  function saveHistory(img){
    try{
      let hist = JSON.parse(localStorage.getItem("qr_hist_v3") || "[]");
      hist.unshift(img);
      hist = hist.slice(0,5);
      localStorage.setItem("qr_hist_v3", JSON.stringify(hist));
      loadHistory();
    }catch(e){}
  }

  function loadHistory(){
    let hist = [];
    try{ hist = JSON.parse(localStorage.getItem("qr_hist_v3") || "[]"); }catch(e){}
    const box = $("history");
    if (!hist.length){
      box.innerHTML = `<span style="font-size:12px;color:var(--muted2);">No exports yet.</span>`;
      return;
    }
    box.innerHTML = hist.map(src => `<img class="thumb" src="${src}" alt="Recent QR" onclick="restore('${src}')" />`).join("");
  }

  function restore(src){
    const img = new Image();
    img.onload = () => {
      const size = chosenSize();
      canvas.width = size; canvas.height = size;
      const ctx = canvas.getContext("2d");
      ctx.clearRect(0,0,size,size);
      ctx.drawImage(img, 0,0,size,size);
      qrGenerated = true;
      setPills("Restored", "ok");
      setMeta("(restored image)");
    };
    img.src = src;
  }

  function clearHistory(){
    try{ localStorage.removeItem("qr_hist_v3"); }catch(e){}
    loadHistory();
    showToast("History cleared.");
  }
  loadHistory();

  // ---------- Actions ----------
  function generate(){
    const data = buildData();
    if (!data){
      setPills("Missing fields", "warn");
      showToast("Fill in the fields for the selected mode.");
      return;
    }
    lastText = data;
    render(data);
    qrGenerated = true;
    setMeta(data);
    setPills("Generated", "ok");
    saveHistory(canvas.toDataURL("image/png"));
  }

  function triggerDownload(dataUrl, ext){
    const a = document.createElement("a");
    const ts = new Date().toISOString().replace(/[:.]/g, "-");
    a.download = `qr-${ts}.${ext}`;
    a.href = dataUrl;
    document.body.appendChild(a);
    a.click();
    a.remove();
  }

  function download(type){
    if (!qrGenerated){
      setPills("Generate first", "warn");
      showToast("Generate a QR code first.");
      return;
    }
    // ensure fresh composite
    render(lastText);

    if (type === "jpeg"){
      // JPEG needs a white background
      const tmp = document.createElement("canvas");
      tmp.width = canvas.width; tmp.height = canvas.height;
      const tctx = tmp.getContext("2d");
      tctx.fillStyle = "#ffffff";
      tctx.fillRect(0,0,tmp.width,tmp.height);
      tctx.drawImage(canvas, 0, 0);
      triggerDownload(tmp.toDataURL("image/jpeg", 0.92), "jpg");
      saveHistory(canvas.toDataURL("image/png"));
      return;
    }

    triggerDownload(canvas.toDataURL("image/png"), "png");
    saveHistory(canvas.toDataURL("image/png"));
  }

  function printQR(){
    if (!qrGenerated){
      setPills("Generate first", "warn");
      showToast("Generate a QR code first.");
      return;
    }
    render(lastText);
    window.print();
  }

  async function copyText(){
    if (!lastText){
      showToast("Nothing to copy yet.");
      return;
    }
    try{
      await navigator.clipboard.writeText(lastText);
      showToast("Copied encoded text.");
    }catch(e){
      showToast("Clipboard blocked by browser.");
    }
  }

  async function copyImage(){
    if (!qrGenerated){
      showToast("Generate a QR first.");
      return;
    }
    if (!navigator.clipboard || !window.ClipboardItem){
      showToast("Image copy not supported here. Use Export PNG.");
      return;
    }
    try{
      render(lastText);
      const blob = await new Promise(res => canvas.toBlob(res, "image/png"));
      await navigator.clipboard.write([new ClipboardItem({ "image/png": blob })]);
      showToast("Copied QR image.");
    }catch(e){
      showToast("Clipboard blocked. Use Export PNG.");
    }
  }

  // ---------- Theme ----------
  function applyTheme(theme){
    document.body.classList.toggle("light", theme === "light");
    $("themeIcon").textContent = theme === "light" ? "‚òÄÔ∏è" : "üåô";
    $("themeLabel").textContent = theme === "light" ? "Light" : "Dark";
  }
  function toggleTheme(){
    const next = document.body.classList.contains("light") ? "dark" : "light";
    applyTheme(next);
    try{ localStorage.setItem("qr_theme_v3", next); }catch(e){}
  }
  (function initTheme(){
    let t = "dark";
    try{ t = localStorage.getItem("qr_theme_v3") || "dark"; }catch(e){}
    applyTheme(t);
  })();

  // init blank QR at correct size
  render("");
</script>
</body>
</html>
